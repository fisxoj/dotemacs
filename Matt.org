#+TITLE: Matt's Emacs configuration

* General

** Changing cases
#+BEGIN_SRC emacs-lisp
  (use-package string-inflection
    :bind (("C-c I" . string-inflection-cycle)))
#+END_SRC
* Diminish
#+BEGIN_SRC emacs-lisp
(use-package diminish :ensure t)
#+END_SRC
** Unicode
https://thraxys.wordpress.com/2016/01/13/utf-8-in-emacs-everywhere-forever/
#+BEGIN_SRC emacs-lisp
(setq locale-coding-system 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
(when (display-graphic-p)
   (setq x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING)))
#+END_SRC

** Packages

#+begin_src emacs-lisp
  (setf use-package-always-ensure t)
#+end_src

** Numerous tweaks to default emacs settings
Many of these things are borrowed from [[http://pages.sachachua.com/.emacs.d/Sacha.html][Sacha Chua's configuration]].
#+begin_src emacs-lisp
  ;; No splash screen!  Why did it take you so long to add this?
  (setq inhibit-startup-message t
	inhibit-startup-screen t)

  ;; No toolbar
  (tool-bar-mode -1)

  ;; Never tabs by default
  (setq-default indent-tabs-mode nil)

  ;; Match parens
  (show-paren-mode 1)

  ;; No bells or flashes, please
  (setq ring-bell-function 'ignore)

  ;; Visual line mode by default
  (global-visual-line-mode 1)

  (defalias 'yes-or-no-p 'y-or-n-p)
  (global-auto-revert-mode 1)
  (setf truncate-lines nil)

  ;; No blinking
  (blink-cursor-mode -1)

  ;; Don't bg emacs on C-z
  (global-set-key (kbd "C-z")
		  (lambda ()
		    (interactive)
		    (message "Not sending emacs to background, you fat-fingered dummy!")))

  (setf confirm-kill-emacs 'y-or-n-p)
#+end_src

Allow narrowing buffers, I know how to use it
#+begin_src emacs-lisp
(put 'narrow-to-region 'disabled nil)
(put 'upcase-region 'disabled nil)
(put 'downcase-region 'disabled nil)
#+end_src

Replace the default scratch message with something more fun
#+BEGIN_SRC emacs-lisp
  (use-package adafruit-wisdom
    :custom
    (inhibit-startup-message t)
    (initial-scratch-message (concat ";; " (adafruit-wisdom-select) "\n")))
#+END_SRC
** Backup

#+begin_src emacs-lisp
(setq backup-directory-alist '(("." . "~/.emacs.d/backups")))
(setq delete-old-versions -1)
(setq version-control t)
(setq vc-make-backup-files t)
(setq auto-save-file-name-transforms '((".*" "~/.emacs.d/auto-save-list/" t)))
#+end_src
** Theme
#+begin_src emacs-lisp
  (use-package color-theme)
  (use-package base16-theme
    :config
    (load-theme 'base16-oceanicnext t))

  (defun fisxoj/day-theme ()
    (interactive)
    (load-theme 'base16-default-light t))

  (defun fisxoj/night-theme ()
    (interactive)
    (load-theme 'base16-oceanicnext t))
#+end_src
** Font
;; http://sourcefoundry.org/hack/
#+BEGIN_SRC emacs-lisp
(when (eq system-type 'gnu/linux)
  (set-frame-font "Inconsolata-10"))
#+END_SRC
** Input
Duplicate a line
#+begin_src emacs-lisp
(defun fisxoj/duplicate-line()
  (interactive)
  (move-beginning-of-line 1)
  (kill-line)
  (yank)
  (open-line 1)
  (next-line 1)
  (yank))

(global-set-key (kbd "C-c C-d") 'fisxoj/duplicate-line)
#+end_src

If I'm typing another alphabet, it's probably japanese
#+begin_src emacs-lisp
  (setq default-input-method "japanese")
#+end_src
** Saving
Delete trailing whitespace
#+begin_src emacs-lisp
  ;; http://ergoemacs.org/emacs/elisp_compact_empty_lines.htmlrevi
  (add-hook 'before-save-hook 'delete-trailing-whitespace)
#+end_src
** Window Decorations
#+begin_src emacs-lisp
(when window-system
  (tooltip-mode -1)
  (tool-bar-mode -1)
  (menu-bar-mode -1)
  (scroll-bar-mode -1))
#+end_src
** Centering Text for Reading
http://alexkehayias.tumblr.com/post/98888273308/simple-centered-text-mode-in-emacs
#+BEGIN_SRC emacs-lisp
  (defun center-text ()
    "Center the text in the middle of the buffer. Works best in full screen"
    (interactive)
    (set-window-margins (car (get-buffer-window-list (current-buffer) nil t))
                          (/ (window-width) 4)
                          (/ (window-width) 4)))

  (defun center-text-clear ()
    (interactive)
    (set-window-margins (car (get-buffer-window-list (current-buffer) nil t))
                          nil
                          nil))

  (setq centered nil)

  (defun center-text-mode ()
    (interactive)
    (if centered
      (progn (center-text-clear)
             (setq centered nil))
      (progn (center-text)
             (setq centered t))))

  (global-set-key (kbd "C-c M-t") 'center-text-mode)
#+END_SRC
** Mail
#+begin_src emacs-lisp
  (setq smtpmail-smtp-server "smtp.gmail.com"
        smtpmail-smtp-service 587
        send-mail-function (quote smtpmail-send-it))
#+end_src
** Eshell
#+BEGIN_SRC emacs-lisp
  (use-package eshell-git-prompt
    :init
    (eshell-git-prompt-use-theme 'powerline))
#+END_SRC
* I/O
** Elfeed
#+begin_src emacs-lisp
  (use-package elfeed
    :custom
    (elfeed-feeds
        '(;; "http://planet.gnome.org/rss20.xml"
          ("http://mjg59.dreamwidth.org/data/rss" linux) ;; Matthew Garrett
          ("http://sarah.thesharps.us/feed/" linux) ;; Sarah Sharp
          ("http://planet.lisp.org/rss20.xml" code lisp)
          ("http://sachachua.com/blog/feed" emacs inspiration) ;; Sacha Chua
          ("http://nullprogram.com/feed/" emacs) ;; Chris Wellons
          ("http://readthiseatthat.blogspot.com/feeds/posts/default?alt=rss" books)
          ("http://slime-tips.tumblr.com/rss" emacs lisp)
          ("http://emacshorrors.com/feed" emacs)
          ("http://www.antipope.org/charlie/blog-static/atom.xml" books) ;; Charles Stross
          ;; "https://letsencrypt.org/feed.xml"
          ("http://blog.8arrow.org/rss" lisp) ;; Eitaro Fukamachi
          ("http://eudoxia.me/feed.xml" lisp) ;; Fernando Boretti
          ("https://drmeister.wordpress.com/feed/" lisp) ;; Christian Schafmeister
          ("http://www.pvk.ca/atom.xml" lisp) ;; Paul Kuhong (sbcl)
          ("https://mollermara.com/rss.xml" emacs)
          ("http://www.suspectsemantics.com/atom.xml" rust)
          ("http://birdlord.tumblr.com/" comics books culture) ;; Emily Horne
          ("https://www.harihareswara.net/nb/nb.cgi/syndicate/sumana" linux) ;; Sumana Harihareswara
          ("https://jvns.ca/atom.xml" ruby rust) ;; Julia Evans
          ("http://jensimmons.com/blog.xml" web design) ;; Jen Simmons (Mozilla)
          ("http://zerolib.com/feed.xml" lisp emacs) ;; John Jacobsen
          ("http://irreal.org/blog/?feed=rss2" emacs) ;; Irreal
          ))

    :bind (("C-x w" . elfeed)))
#+end_src

Taken from [[https://github.com/skeeto/elfeed/issues/34#issuecomment-158824561][here]].
#+BEGIN_SRC emacs-lisp
(defun my-elfeed-store-link ()
  "Store a link to an elfeed search or entry buffer."
  (cond ((derived-mode-p 'elfeed-search-mode)
         (org-store-link-props
          :type "elfeed"
          :link (format "elfeed:%s" elfeed-search-filter)
          :description elfeed-search-filter))
        ((derived-mode-p 'elfeed-show-mode)
         (org-store-link-props
          :type "elfeed"
          :link (format "elfeed:%s#%s"
                        (car (elfeed-entry-id elfeed-show-entry))
                        (cdr (elfeed-entry-id elfeed-show-entry)))
          :description (elfeed-entry-title elfeed-show-entry)))))

(defun my-elfeed-open (filter-or-id)
  "Jump to an elfeed entry or search, depending on what FILTER-OR-ID looks like."
  (message "filter-or-id: %s" filter-or-id)
  (if (string-match "\\([^#]+\\)#\\(.+\\)" filter-or-id)
      (elfeed-show-entry (elfeed-db-get-entry (cons (match-string 1 filter-or-id)
                                                    (match-string 2 filter-or-id))))
    (switch-to-buffer (elfeed-search-buffer))
    (unless (eq major-mode 'elfeed-search-mode)
      (elfeed-search-mode))
    (elfeed-search-set-filter filter-or-id)))

(org-add-link-type "elfeed" #'my-elfeed-open)
(add-hook 'org-store-link-functions #'my-elfeed-store-link)
#+END_SRC

** Notmuch
#+begin_src emacs-lisp
  (use-package notmuch
    :defer t
    :config (require 'org-notmuch))
#+end_src
* Meta-Modes
Projects, SVC, etc

** Ivy
https://www.reddit.com/r/emacs/comments/910pga/tip_how_to_use_ivy_and_its_utilities_in_your/
#+BEGIN_SRC emacs-lisp
  (use-package ivy
    :defer 0.1
    :diminish
    :bind (("C-c C-r" . ivy-resume)
           ("C-x b" . ivy-switch-buffer)
           ("C-x B" . ivy-switch-buffer-other-window))
    :custom
    (ivy-count-format "(%d/%d) ")
    (ivy-display-style 'fancy)
    (ivy-use-virtual-buffers t)
    :config
    (ivy-mode))

  (use-package ivy-rich
    :after ivy
    :custom
    (ivy-virtual-abbreviate 'full
                            ivy-rich-switch-buffer-align-virtual-buffer t
                            ivy-rich-switch-buffer-transformer 'abbrev)
    :config
    (ivy-rich-mode))
#+END_SRC
** Counsel
#+BEGIN_SRC emacs-lisp
  (use-package counsel
    :after ivy
    :bind (("C-x C-f" . counsel-find-file)
           ("M-x" . counsel-M-x)
           ("M-y" . counsel-yank-pop)))
#+END_SRC
** Magit
#+begin_src emacs-lisp
  (use-package magit
    :defer t
    :bind (("C-x g" . magit-status)
           :map magit-mode-map
           ("H f" . github-browse-file)
           ("H b" . github-browse-file-blame)
           ("v" . endless/visit-pull-request-url))
    :config
    (use-package github-browse-file)
    (defun endless/visit-pull-request-url ()
      "Visit the current branch's PR on Github."
      (interactive)
      (browse-url
       (format "https://github.com/%s/pull/new/%s"
               (replace-regexp-in-string
                "\\`.+github\\.com:\\(.+\\)\\.git\\'" "\\1"
                (magit-get "remote"
                           (magit-get-push-remote)
                           "url"))
               (magit-get-current-branch))))
    (setq magit-completing-read-function 'ivy-completing-read))
#+end_src

Open pull request URLs in the browser
#+BEGIN_SRC emacs-lisp
  (defun magit-visit-pull-request-url ()
    "Visit the current branch's PR on GitHub."
    (interactive)
    (let ((remote-branch (magit-get-remote-branch)))
      (cond
       ((null remote-branch)
        (message "No remote branch"))
       (t
        (browse-url
         (format "https://github.com/%s/pull/new/%s"
                 (replace-regexp-in-string
                  ".+github\\.com:\\(.+\\)\\(\\.git\\)?" "\\1" ;"[.@]+github\\.com:\\(.+\\)\\.git" "\\1"
                  (magit-get "remote"
                             (magit-get-remote)
                             "url"))
                 (cdr remote-branch)))))))

  (eval-after-load 'magit
    '(define-key magit-mode-map "v"
       #'magit-visit-pull-request-url))
#+END_SRC
** Projectile
#+begin_src emacs-lisp
  (use-package projectile
    :bind (("C-c p" . projectile-command-map)
           :map projectile-command-map
           (("s s" . counsel-projectile-rg)))
    :init
    (projectile-mode)

    :config
    (defun projectile-cl-project-p ()
      "Identifies a project as being common lisp by the presence of files with .cl or .lisp extensions"
      (-any? (lambda (file)
               (let ((extension (file-name-extension file)))
                 (or (string= extension "lisp")
                     (string= extension "cl"))))
             (projectile-current-project-files)))

    (defun projectile-cl-test-function ()
      "Calls into slime to run the current project's tests with asdf."
      (multiple-value-bind (repl-name async-eval)
          (cond
           ((require 'sly nil t) '("sly" sly-eval-async))
           ((require 'slime nili t) '("slime" slime-eval-async))
           (t (error "Neither sly nor slime seems to be installed.")))
        (message "Testing %s in %s..." (projectile-project-name) repl-name)
        (funcall
         async-eval
         `(asdf:test-system ,(projectile-project-name))
         (lambda (result) (message "Tests finished with result %s" result))
         "CL-USER")))

    (projectile-register-project-type 'common-lisp
                                      #'projectile-cl-project-p
                                      :test #'projectile-cl-test-function)

    :custom
    (projectile-enable-caching nil)
    (projectile-completion-system 'ivy)
    (projectile-switch-project-action 'projectile-vc))

  (use-package projectile-ripgrep
    :after projectile)

  (use-package counsel-projectile
    :after projectile)
#+end_src
** Multiple Cursors
#+begin_src emacs-lisp
  (use-package multiple-cursors
    :defer t
    :bind (("C->" . mc/mark-next-like-this)
           ("C-<" . mc/mark-previous-like-this)
           ("C-c C->" . mc/mark-all-like-this-dwim)
           ("C-:" . mc/mark-next-lines)))
#+end_src

** Swiper
#+BEGIN_SRC emacs-lisp
  (use-package swiper
    :after ivy
    :bind (("C-s" . swiper)
           ("C-r" . swiper)))

#+END_SRC
** Dim
#+BEGIN_SRC emacs-lisp
  (use-package dim
   :init
  (dim-major-names
     '((emacs-lisp-mode    "EL")
       (lisp-mode          "CL")
       (Info-mode          "I")
       (help-mode          "H")
       (typescript-mode    "TS")
       (js2-mode           "JS2")
       (python-mode        "🐍")))
  (dim-minor-names
   '((auto-fill-function " ↵")
     (isearch-mode       " 🔎")
     (whitespace-mode    " _"  whitespace)
     (paredit-mode       " ()" paredit)
     (eldoc-mode         ""    eldoc)
     (ivy-mode           " ❦")
     (projectile-mode    " 🎯")
     (flyspell-mode      " 🐦")
     (org-indent-mode    "")
     (magit-mode         " ❇")
     (writegood-mode     " ✎")
     (tide-mode          " 🌊")
     (visual-line-mode   " ⤸"))))
#+END_SRC
** Writegood
#+BEGIN_SRC emacs-lisp
(use-package writegood-mode)
#+END_SRC
** Jira
#+BEGIN_SRC emacs-lisp
  (use-package org-jira
    :custom
    (jiralib-url "https://themuse.atlassian.net/")
    (org-jira-done-states '("Fertig" "Done" "Closed" "Resolved")))
#+END_SRC
** Smartparens
#+BEGIN_SRC emacs-lisp
  (use-package smartparens
    :config
    (sp-use-paredit-bindings))
#+END_SRC
** Rainbow
#+BEGIN_SRC emacs-lisp
  (use-package rainbow-mode)
#+END_SRC
** Company
#+BEGIN_SRC emacs-lisp
  (use-package company
    :custom
    (company-begin-commands '(self-insert-command))
    (company-idle-delay 0.1)
    (company-minimum-prefix-length 2)
    (company-tooltip-align-annotations t))

  (when (>= emacs-major-version 26)
    (use-package company-box
      :after company-mode
      :diminish
      :hook company-mode
      :custom
      (company-box-doc-delay 0.2)))
#+END_SRC
** Paredit
#+BEGIN_SRC emacs-lisp
  (use-package paredit
    :hook ((lisp-mode . paredit-mode)
           (emacs-lisp-mode . paredit-mode)
           (sly-mrepl-mode . paredit-mode)))
#+END_SRC
** Editorconfig
   #+BEGIN_SRC emacs-lisp
     (use-package editorconfig
       :config
       (editorconfig-mode 1))
   #+END_SRC
** Flycheck
   #+BEGIN_SRC emacs-lisp
     (use-package flycheck
       :custom
       (flycheck-check-syntax-automatically '(save mode-enabled)))
   #+END_SRC
* Language Modes
** Org
#+begin_src emacs-lisp
  (setq org-directory "~/Documents/Notes/"
        org-journal-dir "~/Documents/Notes/")
#+end_src
*** Presentation
#+begin_src emacs-lisp
  (add-hook 'org-mode-hook
            (lambda ()
              (writegood-mode)
              (flyspell-mode)))
  (setq org-ellipsis "⤵"
        org-startup-with-inline-images t)
#+end_src
*** Babel
#+begin_src emacs-lisp
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((gnuplot . t)
     (lisp    . t)
     (maxima  . t)
     (python  . t)
     (clojure . t)))

  (setq org-confirm-babel-evaluate nil
        org-src-tab-acts-natively t)
#+end_src
*** Capture
#+begin_src emacs-lisp
  (define-key global-map "\C-cc" 'org-capture)
  (setq org-capture-templates
        '(("t" "Todo" entry
           (file+headline "~/Documents/Notes/todo.org" "Tasks")
           "* TODO %?\nEntered %U\n  %i\n  %a")
          ("T" "Ticket" entry
           (file+headline "~/Documents/Notes/tickets.org" "Tickets")
           "* TODO %?\nEntered %U\n")
          ("j" "Journal" entry
           (file+datetree "~/Documents/Notes/journal.org")
           "* %?\nEntered %U\n  %i\n  %a")
          ("n" "Note" entry
           (file+datetree "~/Documents/notebook.org")
           "* %?\nEntered %U\n %i\n %a")
          ;; http://stackoverflow.com/questions/14666625/combine-org-mode-capture-and-drill-modules-to-learn-vocabulary
          ("J" "Japanese" entry
           (file+headline "~/Documents/japanese drill.org" "Vocabulary")
           "* %^{The word} :drill:\n %t\n %^{kana|%\\1} \n** Answer \n%^{The definition}"
           :immediate-finish t))
        org-refile-targets '(("todo.org" :level . 1)))
#+end_src

Store link
#+begin_src emacs-lisp
(define-key global-map "\C-cl" 'org-store-link)
#+end_src
*** Linking
#+BEGIN_SRC emacs-lisp
  (use-package orgit
    :after org)
#+END_SRC
*** Journal
#+begin_src emacs-lisp
(defvar org-journal-file "~/Documents/Notes/journal.org"
  "Path to OrgMode journal file.")

(defvar org-journal-dir "~/Documents/Notes/")

(defvar org-journal-date-format "%Y-%m-%d"
  "Date format string for journal headings.")
#+end_src
*** Speed Keys
#+begin_src emacs-lisp

#+end_src
*** Logging
#+begin_src emacs-lisp
(setq org-log-done t)
#+end_src
*** Export
#+begin_src emacs-lisp
(use-package ox-html5slide)
(use-package org-re-reveal)
#+end_src
**** LateX
#+begin_src emacs-lisp
   (setf TeX-engine 'xetex)


   (setq org-export-latex-todo-keyword-markup
         '((t      . "\\textbf{%s}")
           ("TODO" . "\\textcolor{red}{TODO}")
           ("DONE" . "\\textcolor{green}{DONE}"))
         org-latex-pdf-process (list "latexmk -pdflatex=xelatex -shell-escape -pdf -bibtex %f")
         org-format-latex-header
               "\\documentclass{article}
   \\usepackage[usenames]{color}
   [PACKAGES]
   [DEFAULT-PACKAGES]
   \\include{physics}
   \\pagestyle{empty}             % do not remove
   % The settings below are copied from fullpage.sty
   \\setlength{\\textwidth}{\\paperwidth}
   \\addtolength{\\textwidth}{-3cm}
   \\setlength{\\oddsidemargin}{1.5cm}
   \\addtolength{\\oddsidemargin}{-2.54cm}
   \\setlength{\\evensidemargin}{\\oddsidemargin}
   \\setlength{\\textheight}{\\paperheight}
   \\addtolength{\\textheight}{-\\headheight}
   \\addtolength{\\textheight}{-\\headsep}
   \\addtolength{\\textheight}{-\\footskip}
   \\addtolength{\\textheight}{-3cm}
   \\setlength{\\topmargin}{1.5cm}
   \\addtolength{\\topmargin}{-2.54cm}"
               org-latex-image-default-width ".6\\linewidth")

(dolist (class '(;; Presentation beamer class
		 ("presentation"
		  "\\documentclass{beamer}
		\\usetheme[alternativetitlepage=true]{Torino}
		%\\usecolortheme{{{{beamercolortheme}}}}
		\\usepackage{fontspec}
		\\include{common}
		\\include{physics}"
		  ("\\section{%s}" . "\\section*{%s}")

		  ("\\begin{frame}[fragile]\\frametitle{%s}"
		   "\\end{frame}"
		   "\\begin{frame}[fragile]\\frametitle{%s}"
		   "\\end{frame}"))

		 ;; Revtex class
		 ("revtex"
		  "\\documentclass{revtex4-1}
		\\usepackage{fontspec}
		\\usepackage{graphicx}
		[NO-DEFAULT-PACKAGES]"
		  ("\\section{%s}" . "\\section*{%s}")

		  ("\\subsection{%s}" . "\\subsection*{%s}"))
		 ;; Problem set class
		 ("problemset"
               "\\documentclass{article}[10pt]
                 [NO-DEFAULT-PACKAGES]
                 \\include{common}
		\\include{physics}
		\\renewcommand\\thesubsection{\\textcircled{\\alph{subsection}}}"
               ("\\section{%s}" . "\\section{%s}")
               ("\\subsection{%s}" . "\\subsection{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection{%s}")
               ("\\paragraph{%s}" . "\\paragraph{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph{%s}"))

		 ;; notes
		 ("notes"
               "\\documentclass{article}[10pt]
                [NO-DEFAULT-PACKAGES]
                \\include{common}
		\\include{physics}"
               ("\\section{%s}" . "\\section{%s}")
               ("\\subsection{%s}" . "\\subsection{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection{%s}")
               ("\\paragraph{%s}" . "\\paragraph{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph{%s}"))))
  ;; Add classes to export list
  (add-to-list 'org-latex-classes
	       class))
#+end_src
**** Reveal
#+begin_src emacs-lisp
(setq org-reveal-root "http://cdn.jsdelivr.net/reveal.js/3.0.0/")
#+end_src
*** Babel
#+begin_src emacs-lisp
(setq org-src-fontify-natively t)
#+end_src
*** Agenda
#+begin_src emacs-lisp
  (define-key global-map "\C-ca" 'org-agenda)

  (setf org-agenda-files
        (quote ("~/Documents/Notes/journal.org"
                "~/Documents/Notes/todo.org")))
#+end_src
** Web
#+begin_src emacs-lisp
  (use-package prettier-js)
  (use-package web-mode
    :mode (("\\.phtml\\'" . web-mode)
           ("\\.tpl\\.php\\'" . web-mode)
           ("\\.[gj]sp\\'" . web-mode)
           ("\\.as[cp]x\\'" . web-mode)
           ("\\.erb\\'" . web-mode)
           ("\\.mustache\\'" . web-mode)
           ("\\.djhtml\\'" . web-mode)
           ("\\.ejs\\'" . web-mode)
           ("\\.scss\\'" . web-mode)
           ("\\.css\\'" . web-mode)
           ("\\.html?\\'" . web-mode)
           ;; Mithril coat templates
           ("\\.coat\\'" . web-mode)
           ("\\.jsx?\\'" . web-mode))

    :hook ((web-mode . rainbow-mode)
           (web-mode . flyspell-prog-mode))
    :requires rainbow-mode
    :custom
    (web-mode-engines-alist '(("django" . "\\.html")))

    :config
    (flycheck-add-mode 'javascript-eslint 'web-mode)
    (add-hook 'web-mode-hook (lambda ()
                               (when (find web-mode-content-type '("jsx" "javascript") :test 'equal)
                                 (tide-mode +1)
                                 (company-mode +1)
                                 (tide-hl-identifier-mode +1)
                                 (flycheck-mode +1)
                                 (eldoc-mode +1)
                                 (tide-setup)
                                 (smartparens-mode +1))))

    ;; (defadvice web-mode-highlight-part (around tweak-jsx activate)
    ;;   (if (equal web-mode-content-type "jsx")
    ;;       (let ((web-mode-enable-part-face nil))
    ;;         ad-do-it)
    ;;     ad-do-it))
    )
#+end_src
** Javascript
*** Typescript
 #+BEGIN_SRC emacs-lisp
   (use-package tide)
   (use-package typescript-mode
     :mode "\\.tsx?\\'"
     :hook ((before-save . (lambda () (when (equal major-mode 'typescript-mode) tide-format-before-save)))
            (typescript-mode . company-mode)
            (typescript-mode . smartparens-mode)
            (typescript-mode . flycheck-mode)
            (typescript-mode . eldoc-mode)
            (typescript-mode . tide-hl-identifier-mode)
            (typescript-mode . tide-setup))
     :after tide)
 #+END_SRC
*** Flow
    #+BEGIN_SRC emacs-lisp
      (use-package company-flow)
      (use-package flycheck-flow
        :config
        (flycheck-add-mode 'javascript-flow 'web-mode))
    #+END_SRC
** Lisp
#+begin_src emacs-lisp
  ;; (when (file-exists-p (expand-file-name "~/quicklisp/slime-helper.el"))
  ;;   (use-package slime
  ;;   :init
  ;;   (load (expand-file-name "~/quicklisp/slime-helper.el"))
  ;;   (when (file-exists-p (expand-file-name "~/.emacs.d/slime-repl-ansi-color.el"))
  ;;     (load (expand-file-name "~/.emacs.d/slime-repl-ansi-color.el")))

  ;;   :custom
  ;;   (inferior-lisp-program "sbcl --dynamic-space-size 2560")
  ;;   (slime-contribs '(slime-fancy slime-banner slime-repl-ansi-color slime-company))

  ;;   :config
  ;;   (slime-setup slime-contribs)

  ;;   :hook
  ;;   (lisp-mode . paredit-mode)
  ;;   (slime-mode . paredit-mode)))

  (use-package sly
    :custom
    (inferior-lisp-program "sbcl")
    :hook
    ((lisp-mode . paredit-mode)
     (lisp-mode . company-mode)
     (lisp-mode . flyspell-prog-mode)
     (sly-editing-mode . paredit-mode))
    :init
    (push 'sly-repl-ansi-color sly-contribs))

  (use-package sly-repl-ansi-color
    :after sly)

  (use-package sly-named-readtables
    :after sly)

  (use-package sly-macrostep
    :after sly)

  (use-package sly-quicklisp
    :after sly)
#+end_src
** Elm
#+BEGIN_SRC emacs-lisp
  (use-package elm-mode
    :config
    (add-hook 'flycheck-mode 'flycheck-elm-setup)
    (add-to-list 'company-backends 'company-elm)
    (add-hook 'elm-mode-hook 'elm-oracle-setup-completion))
#+END_SRC
** Python
#+BEGIN_SRC emacs-lisp
  (use-package flycheck-mypy
    :config
    (add-to-list 'flycheck-enabled-checkers 'python-mypy)

    :custom
    (flycheck-python-mypy-args '("--ignore-missing-imports"))
    (flycheck-python-flake8-executable "python3")
    (flycheck-python-pylint-executable "python3")
    (flycheck-python-pycompile-executable "python3"))

  (use-package fill-column-indicator
    :config
    ;; Override FCI in babel block so it doesn't fuck up formatting there
    (defun fci-mode-override-advice (&rest args))
    (advice-add 'org-html-fontify-code :around
                (lambda (fun &rest args)
                  (advice-add 'fci-mode :override #'fci-mode-override-advice)
                  (let ((result  (apply fun args)))
                    (advice-remove 'fci-mode #'fci-mode-override-advice)
                    result)))
    ;; Set the bar at 80 chars, PEP8-style
    (setq fci-rule-column 80))

  (use-package elpy
    :requires (flycheck-mypy fill-column-indicator)
    :hook ((elpy-mode . flycheck-mode)
           (elpy-mode . fci-mode)
           (python-mode . elpy-mode)
           (elpy-mode . smartparens-mode))
    :diminish (elpy-mode . "☕")
    :custom
    (elpy-rpc-backend "jedi")
    (elpy-rpc-python-command "python3")
    :config
    (elpy-enable)
    (setq elpy-modules (delq 'elpy-module-flymake elpy-modules))
    (setq-default flycheck-disabled-checkers '(flycheck-flake8 flycheck-pycompile)))
#+END_SRC
** Coffeescript
#+BEGIN_SRC emacs-lisp
(setq coffee-tab-width 4)
#+END_SRC
** Rust
Based on/copied from http://bassam.co/emacs/2015/08/24/rust-with-emacs/
#+BEGIN_SRC emacs-lisp
  (use-package rust-mode
    :after (racer lsp-mode)
    :hook ((rust-mode . lsp)
           (rust-mode . smartparens-mode)
           (rust-mode . company-mode)))
#+END_SRC
** Octave
#+begin_src emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.m$" . octave-mode))
#+end_src
** LaTeX
#+begin_src emacs-lisp
(setq TeX-auto-save t
      TeX-parse-self t
      TeX-save-query nil
      TeX-PDF-mode t)

(add-hook 'LaTeX-mode-hook 'flyspell-mode)
(add-hook 'LaTeX-mode-hook 'flyspell-buffer)
#+end_src
** Ruby
#+begin_src emacs-lisp
  (use-package enh-ruby-mode
    :interpreter "ruby"
    :hook (enh-ruby-mode . ruby-electric-mode)
    :mode (("\\.rb$" . enh-ruby-mode)
           ("\\.rake$" . enh-ruby-mode)
           ("Rakefile$" . enh-ruby-mode)
           ("\\.gemspec$" . enh-ruby-mode)
           ("\\.ru$" . enh-ruby-mode)
           ("Gemfile$" . enh-ruby-mode)
           ("\\.json.jbuilder$" . enh-ruby-mode)))

#+end_src
** Clojure
#+begin_src emacs-lisp
  (use-package cider
    :requires paredit
    :hook ((clojure-mode . paredit-mode)
           (clojure-mode . turn-on-eldoc-mode))
    :custom
    (nrepl-hide-special-buffers t)
    (cider-repl-pop-to-buffer-on-connect nil)
    (cider-show-error-buffer nil)
    (cider-repl-popup-stacktraces t)
    (cider-lein-command "lein"))
#+end_src
** Go
#+BEGIN_SRC emacs-lisp
  (use-package go-mode
    :bind (:map go-mode-map
                ("M-." . godef-jump))
    :config
    (let ((gopath (expand-file-name "~/Code/gocode"))
        (gobin (expand-file-name "~/Code/gocode/bin")))
      (setenv "GOPATH" gopath)
      (setenv "GOBIN" gobin)
      (add-to-list 'exec-path gobin)
      (add-hook 'before-save-hook
                (lambda ()
                  (when (eq major-mode 'go-mode)
                    (gofmt-before-save))))

      (flycheck-define-checker go-goflymake
        "A Go syntax and style checker using the go utility.
      See URL `https://github.com/dougm/goflymake'."
        :command ("goflymake" "-prefix=flycheck_"
                  (eval (if goflymake-debug "-debug=true" "-debug=false"))
                  source-inplace)
        :error-patterns ((error line-start (file-name) ":" line ": " (message) line-end))
        :modes go-mode)

       (add-to-list 'flycheck-checkers 'go-gofmt)))
#+END_SRC

Here's some things to install to make all of these bits work

#+BEGIN_EXAMPLE
go get -u github.com/nsf/gocode
go get -v github.com/rogpeppe/godef
go get -u github.com/dougm/goflymake
go get golang.org/x/tools/cmd/oracle
#+END_EXAMPLE
** WGrep
#+BEGIN_SRC emacs-lisp
(setq wgrep-auto-save-buffer t)
#+END_SRC

** Eldoc
#+BEGIN_SRC emacs-lisp
  (setf eldoc-idle-delay 0.2
        eldoc-echo-area-use-multiline-p t)
#+END_SRC
** Emacs Lisp
#+BEGIN_SRC emacs-lisp
  (add-hook 'emacs-lisp-mode-hook 'turn-on-eldoc-mode)
  (add-hook 'emacs-lisp-mode-hook 'company-mode)
  (add-hook 'emacs-lisp-mode-hook 'flyspell-prog-mode)
  (add-hook 'emacs-lisp-mode-hook 'paredit-mode)
#+END_SRC
** Terraform
   #+BEGIN_SRC emacs-lisp
     (use-package terraform-mode
       :hook ((terraform-mode . company-mode)
	      (terraform-mode . smartparens-mode)))

     (use-package company-terraform
       :init (company-terraform-init))
   #+END_SRC
** Dockerfile
#+BEGIN_SRC emacs-lisp
  (use-package dockerfile-mode)
#+END_SRC
** Markdown
   #+BEGIN_SRC emacs-lisp
     (use-package markdown-mode)
   #+END_SRC
** Scala
   Setup for language server scala [[https://github.com/rossabaker/lsp-scala][lsp-scala]].
   #+BEGIN_SRC emacs-lisp
     (use-package scala-mode
       :hook ((scala-mode . smartparens-mode)))

     (use-package lsp-mode)

     (use-package lsp-ui
       :hook (lsp-mode . lsp-ui-mode)
       :config
       (push 'lsp-ui-flycheck flycheck-checkers))

     (use-package lsp-scala
       :after scala-mode
       :demand t
       :hook ((scala-mode . lsp))
       :init
       (lsp-ui-flycheck-add-mode 'scala-mode)
       (setq lsp-scala-server-command "~/bin/metals-emacs")
       (add-hook 'scala-mode-hook (lambda ()
				    (lsp-ui-flycheck-enable +1))))

     (use-package sbt-mode
       :ensure t
       :commands sbt-start sbt-command)
   #+END_SRC
* Special Commands
** Flip window split
#+BEGIN_SRC emacs-lisp
  (defun fisxoj/toggle-window-split ()
    (interactive)
    (if (= (count-windows) 2)
        (let* ((this-win-buffer (window-buffer))
               (next-win-buffer (window-buffer (next-window)))
               (this-win-edges (window-edges (selected-window)))
               (next-win-edges (window-edges (next-window)))
               (this-win-2nd (not (and (<= (car this-win-edges)
                                           (car next-win-edges))
                                       (<= (cadr this-win-edges)
                                           (cadr next-win-edges)))))
               (splitter
                (if (= (car this-win-edges)
                       (car (window-edges (next-window))))
                    'split-window-horizontally
                  'split-window-vertically)))
          (delete-other-windows)
          (let ((first-win (selected-window)))
            (funcall splitter)
            (if this-win-2nd (other-window 1))
            (set-window-buffer (selected-window) this-win-buffer)
            (set-window-buffer (next-window) next-win-buffer)
            (select-window first-win)
            (if this-win-2nd (other-window 1))))))
#+END_SRC

** Gibberish Generator
#+begin_src emacs-lisp
  (defun insert-gallia ()
    (interactive)
    (insert "Gallia est omnis divisa in partes tres, quarum unam incolunt Belgae, aliam Aquitani, tertiam qui ipsorum lingua Celtae, nostra Galli appellantur.  Hi omnes lingua, institutis, legibus inter se differunt. Gallos ab Aquitanis Garumna flumen, a Belgis Matrona et Sequana dividit.  Horum omnium fortissimi sunt Belgae, propterea quod a cultu atque humanitate provinciae longissime absunt, minimeque ad eos mercatores saepe commeant atque ea quae ad effeminandos animos pertinent important, proximique sunt Germanis, qui trans Rhenum incolunt, quibuscum continenter bellum gerunt. Qua de causa Helvetii quoque reliquos Gallos virtute praecedunt, quod fere cotidianis proeliis cum Germanis contendunt, cum aut suis finibus eos prohibent aut ipsi in eorum finibus bellum gerunt. Eorum una, pars, quam Gallos obtinere dictum est, initium capit a flumine Rhodano, continetur Garumna flumine, Oceano, finibus Belgarum, attingit etiam ab Sequanis et Helvetiis flumen Rhenum, vergit ad septentriones.  Belgae ab extremis Galliae finibus oriuntur, pertinent ad inferiorem partem fluminis Rheni, spectant in septentrionem et orientem solem.  Aquitania a Garumna flumine ad Pyrenaeos montes et eam partem Oceani quae est ad Hispaniam pertinet; spectat inter occasum solis et septentriones."))

  (defun insert-check ()
    "Insert a unicode check mark"
    (interactive)
    (insert "✓"))

  (defun insert-cross ()
    "Insert a unicode cross mark"
    (interactive)
    (insert "✗"))

  (global-set-key (kbd "C-c i g") 'insert-gallia)
  (global-set-key (kbd "C-c i c") 'insert-check)
  (global-set-key (kbd "C-c i x") 'insert-cross)
#+end_src

** Markdown to org
#+BEGIN_SRC emacs-lisp
  (use-package pandoc
    :config
    (defun fisxoj/region-md-to-org (start end)
      (interactive "r")
      (let ((org-content (pandoc-convert-stdio (buffer-substring start end)
                                               "gfm" "org")))
        (delete-region start end)
        (insert org-content))))
#+END_SRC

** Dealing with different monitor pixel densities
#+BEGIN_SRC emacs-lisp
(defun fisxoj/home-mode ()
  (interactive)
  (set-frame-font "Inconsolata-8"))

(defun fisxoj/work-mode ()
  (interactive)
  (set-frame-font "Inconsolata-6"))
#+END_SRC

** Save without running hooks
#+BEGIN_SRC emacs-lisp
(defun fisxoj/save-without-hooks ()
  "Save without running any before-save-hooks"
  (interactive)
  (let ((before-save-hook nil))
    (save-buffer)))
#+END_SRC

** Revisit as root
#+BEGIN_SRC emacs-lisp
(defun fisxoj/revisit-as-root ()
  (interactive)
  (find-alternate-file (concat "/sudo:root@localhost:" buffer-file-name)))
#+END_SRC

* Work Tweaks
Things for my work
#+BEGIN_SRC emacs-lisp
  (when (file-exists-p "jira.el")
    (load "jira.el"))
#+END_SRC
#+BEGIN_SRC emacs-lisp
  (when (file-exists-p "~/.work")
    (set-frame-font "Inconsolata-12" t t))
#+END_SRC
